# 第5回  TSP challenge  

N個の点を全て辿るように始点へ戻るルートの中で、最小のものを探す  
詳細：  
https://github.com/hayatoito/google-step-tsp

**実行方法(例)**
```
python solver_opt.py input_0.csv output_0.csv
```
```
./c++_solver input_0.csv output_0.csv
```

### 実行ファイル 
**solver_opt.py**
- 多始点貪欲 + 焼きなまし法  
参考：
https://qiita.com/take314/items/69b93481403feb857d6e

**c++_solver.cc** 
- solver_opt.pyをc++に翻訳させて、iterationを増やして実行した  

### N = 8192 用の実行ファイル  
- `solver_input7.py`
- `c++_solver_input7.cc`
- とりあえず多始点貪欲法 + opt2で交差解消のみ
- claude.aiにpythonのコードをc++翻訳させて、開始点をたくさん試せるようにした。  

始点を300回試した時  
greedy = 95222.8  
opt2 = 84642.9  ←スコア  

<br>


### チャレンジ2 
- `solve_greedy_multi_start`: 貪欲法を、10個の開始点から試して一番いいものを採用した。  
- opt3_randomは、5万回、3辺の繋ぎ直しを試みた。10万回にしたら若干悪くなったので5万回にしておいた。
- annealingは見たところ機能していなかったので、annealing + opt3_randomと、opt3_randomの違いは、greedyやopt3_randomのランダム性によるものだと考えられる。  
- 焼きなまし(annealing)のどこがおかしくて動いていないのかをおいおい考えていきたいです

<br>


| 手法                                             | N = 5 | N = 8 | N = 16 | N = 64 | N = 128 | N = 512 | N = 2048 |
|--------------------------------------------------|--------|--------|---------|---------|----------|-----------|------------|
| greedy_multi_start + opt2                        | 3418   | 3832   | 4821    | 8773    | 11272    | 21911     | 42465      |
| greedy_multi_start + opt2 + opt3_limited         | 3418   | 3832   | 5065    | 8657    | 11445    | 21975     | 42579      |
| greedy_multi_start + opt2 + opt3_random          | 3418   | 3832   | 4750    | 8612    | **11214**    | 22124     | 42747      |
| greedy_multi_start + opt2 + annealing            | 3418   | 3778   | 4494    | 8845    | 11460    | 22057     | 42605      |
| greedy_multi_start + opt2 + annealing + opt3_random | 3418 | 3778   | 4494    | **8520**    | 11262    | **22052**     | **42348**      |

<br>

### チャレンジ3

焼きなまし法が上手く行った。焼きなまし法の概要について、そもそも理解していなかったことが原因で色々間違えていました。  
c++ のコードでは10億回程度ループするようにしています。
局所解にハマっていそうだったら温度を上げるようにしました。

| 手法                                             | N = 5 | N = 8 | N = 16 | N = 64 | N = 128 | N = 512 | N = 2048 |
|--------------------------------------------------|--------|--------|---------|---------|----------|-----------|------------|
| greedy_multi_start + annealing | 3418 | 3778   | 4494    | **8118**    | **10601**    | **20254.9**     | **41348**      |
 
<br>

## その4　合計距離の計算を高速化して焼きなましをひたすら回す
`c++_solver.cc`
- 焼きなましで、alpha=0.9999.. ではなく、beta=1e-6として、temp = initial_temp / (1 + beta * iter)というように温度を下げていくようにした。
- 指数関数的に温度の下がり方がゆっくりになっていくはず。温度は10度以下になると全然下がらなくなるので、常にある程度は悪い解を受け入れるようになっている。
- 2optとor_optを実行した際に、毎回total_distanceを計算するのではなくて、変更した箇所の差分を計算するようにした。すると計算時間がすごく早くなった。
- 15億回程度回して、N=512で**20077**、N=2048で**40071.93**が出た。
- or_optの差分計算がどこか間違っているようで、ログで表示させた途中経過がtotal_distanceを計算した時と異なってしまっている。今のファイルは簡素化するためにor_1_optしか実装していません。  

## その他のアルゴリズム

### 最小全域木

- プリム法で作成。priority queueを用いて、2点間の距離が最小のノードを繋いでいく。隣接リストからDFSで経路を作る
- 初期解としては貪欲法より悪くなってしまった

参考：https://qiita.com/uniTM/items/a6c5211ce9c9008b74a8  
<br>
**実行結果**  
mst(最小全域木)とgreedy(貪欲法)の比較  
N=512  
mst= 26896.096222884164  
greedy =  24842.661344037304  

N=2048  
mst= 54082.67003571718  
greedy =  49083.78245600319  


### 蟻コロニー最適化

参考：
https://note.com/sabayoshi_yo/n/n58ada57ea1ef
https://ja.wikipedia.org/wiki/%E8%9F%BB%E3%82%B3%E3%83%AD%E3%83%8B%E3%83%BC%E6%9C%80%E9%81%A9%E5%8C%96

蟻がフェロモンを元に確率的にルートを選択していってtourを一周する。
距離が近いノードには多めにフェロモンを残す。徐々に最良のtourを選ぶようになる。

**実行結果(N=512 (input_5.csv))**

```python
[Gen 100] best_length = 22247.8
[Gen 200] best_length = 22000.7
[Gen 300] best_length = 21966.7
[Gen 400] best_length = 21966.7
[Gen 500] best_length = 21966.7
```

最初のループでかなり良い解が出るが、局所解に陥りやすく、tourが改善されなくなってしまった。
パラメータをいじっても結局局所解にハマってしまった。

### 遺伝的アルゴリズム

参考：https://qiita.com/masaru/items/729a0a0e2d7f305e8e90

設定した数のtourに対して、突然変異を一定の確率で発生させる。(ここではpopulation_sizeが、作るtourの数)

いいtourは上位x個までエリート個体として突然変異させない。

**実行結果**

N=512で　[Generation 5500] Best length: 23221.2　

以下の初期値だと、2000* 10000 *0.3しかtourを変化させてないことになるのであまりtourの改善は期待できないのでは
```
初期値：
    int population_size = 2000,
    int generations = 10000, 
    double mutation_rate = 0.3,
    int elite_size = 150
```
